name: Deploy to Vercel

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # Deploy the built `dist` directory to Vercel using the provided token
          # and explicitly target the existing `dist` project to avoid creating
          # a new project with an auto-generated name.
          set -euo pipefail
          DEPLOY_OUT=$(npx vercel --prod ./dist --token "$VERCEL_TOKEN" --yes --project dist 2>&1)
          echo "deploy output:\n$DEPLOY_OUT"
          # extract a production URL from output (first https://... occurrence)
          DEPLOY_URL=$(echo "$DEPLOY_OUT" | grep -Eo "https?://[a-zA-Z0-9._-]+(\.vercel\.app|\.[a-zA-Z0-9._-]+)" | head -n1 || true)
          if [ -z "$DEPLOY_URL" ]; then
            echo "Failed to get deployment URL from vercel output" >&2
            exit 1
          fi
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT

      - name: Alias domain to deployment (optional)
        if: always()
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          DEPLOY_URL: ${{ steps.build-and-deploy.outputs.url }}
        run: |
          # Alias the deployment to the custom domain if a VERCEL_TOKEN secret is present.
          # This step will be skipped (no-op) if `VERCEL_TOKEN` is not set in repo secrets.
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "VERCEL_TOKEN not set â€” skipping alias step. Add repository secret VERCEL_TOKEN to enable automatic aliasing."
            exit 0
          fi
          if [ -z "$DEPLOY_URL" ]; then
            echo "No deployment URL found, skipping alias step."
            exit 0
          fi
          echo "Aliasing $DEPLOY_URL to daily.bitmenders.in"
          npx vercel alias set "$DEPLOY_URL" daily.bitmenders.in --token "$VERCEL_TOKEN"
